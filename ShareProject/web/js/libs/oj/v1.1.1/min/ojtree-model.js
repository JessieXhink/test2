/**
 * Copyright (c) 2014, 2015, Oracle and/or its affiliates.
 * All rights reserved.
 */
"use strict";
define(["ojs/ojcore","jquery","ojs/ojdatacollection-common","ojs/ojmodel"],function(a){a.Ka=function(f){f=f||{};this.Ow=f.root;this.dfa=f.childCollectionCallback;this.Bs=f.parseMetadata;this.Gp=null;this.Gs="none";this.Cd={};a.Ka.q.constructor.call(this)};o_("CollectionTreeDataSource",a.Ka,a);a.Ka.prototype.Bs=function(a){return{key:a.idAttribute+"\x3d"+a.id}};a.b.ga(a.Ka,a.Uc,"oj.CollectionTreeDataSource");a.Ka.prototype.Init=function(){a.Ka.q.Init.call(this)};a.b.i("CollectionTreeDataSource.prototype.Init",
{Init:a.Ka.prototype.Init});a.Ka.prototype.nf=function(a){var d=this.Cd[a];if(d&&0<d.length)return d.length;this.GJ(a,{success:function(a){return a.length}});return-1};a.b.i("CollectionTreeDataSource.prototype.getChildCount",{nf:a.Ka.prototype.nf});a.Ka.prototype.GJ=function(a,d){this.Rd(a,null,{success:function(a){d.success(a.Ea)},error:d.error})};a.b.i("CollectionTreeDataSource.prototype.getChildCollection",{GJ:a.Ka.prototype.GJ});a.Ka.prototype.Rd=function(a,d,b){d=d||{};var c=d.start?d.start:
0,e=d.count?d.count:-1;if(null===a)this.Ls(null,c,e,b,null);else{var g=this;this.RF(this.Ow,a,0).then(function(d){if(d){d=g.Yw(d.sn);try{g.Ls(d,c,e,b,a)}catch(k){b&&b.error&&b.error({status:k.message})}}else b&&b.error&&b.error(a)})}};a.b.i("CollectionTreeDataSource.prototype.fetchChildren",{Rd:a.Ka.prototype.Rd});a.Ka.prototype.F0=function(a,d,b){var c=0;b&&b.at&&(c=b.at);d=this.nz(d);a=this.wy(this,"insert",c,d,this.BU(null!=d&&0<d.length?d[d.length-1]:null,a));this.handleEvent("change",a)};a.Ka.prototype.G0=
function(a,d,b){var c=0;b&&b.index&&(c=b.index);this.lca(a);a=this.wy(this,"delete",c,this.nz(d),null);this.handleEvent("change",a)};a.Ka.prototype.H0=function(a){var d=this.w7(a),b=null,c=null;d&&(b=d.index,c=this.nz(d.Ea));a=this.wy(this,"update",b,c,this.BU(null!=c&&0<c.length?c[c.length-1]:null,a));this.handleEvent("change",a)};a.Ka.prototype.h0=function(a){a=this.wy(this,"refresh",null,this.nz(a),null);this.handleEvent("refresh",a)};a.Ka.prototype.BU=function(f,d){var b=new a.l;b.add(d);return this.ER(b,
f,0,1)};a.Ka.prototype.nz=function(f){var d=[],b=null;do b=this.v8(f),null!==b&&(b!==a.Ka.YL&&d.unshift(b),f=this.x7(b));while(null!=b);return d};a.Ka.YL="%!@ROOT%#@!";a.Ka.prototype.Xy=function(f){var d=f instanceof a.t?this.Bs(f).key:f;return f?d:a.Ka.YL};a.Ka.prototype.dO=function(a){return this.Cd[this.Xy(a)]};a.Ka.prototype.GV=function(f,d){d.on(a.$.J.ADD,this.F0,this);d.on(a.$.J.REMOVE,this.G0,this);d.on(a.$.J.CHANGE,this.H0,this);d.on(a.$.J.SYNC,this.h0,this);this.Cd[this.Xy(f)]=d};a.Ka.prototype.lca=
function(a){a=this.Xy(a);for(var d in this.Cd)if(this.Cd.hasOwnProperty(d)&&d===a){this.Cd[a].off(null,null,this);delete this.Cd[a];break}};a.Ka.prototype.paa=function(a,d){for(var b=d.length,c=0;c<b;c++){var e=this.Xy(d.at(c));if(a===e)return!0}return!1};a.Ka.prototype.w7=function(a){for(var d in this.Cd)if(this.Cd.hasOwnProperty(d))for(var b=this.Cd[d],c=0;c<b.length;c++)if(b.at(c)===a)return{index:c,Ea:b};return null};a.Ka.prototype.x7=function(a){for(var d in this.Cd)if(this.Cd.hasOwnProperty(d)){var b=
this.Cd[d];if(this.paa(a,b))return b}return null};a.Ka.prototype.v8=function(a){for(var d in this.Cd)if(this.Cd.hasOwnProperty(d)&&this.Cd[d]===a)return d;return null};a.Ka.prototype.Yw=function(a){var d=!0,b=this.dO(a);b||(d=!1,b=this.dfa(this.Ow,a),null!=b&&(this.tO(b),this.GV(a,b)));return{Ea:b,hJ:d}};a.Ka.prototype.wy=function(a,d,b,c,e){return{source:a,operation:d,index:b,parent:c,data:e}};a.Ka.prototype.Ls=function(a,d,b,c,e){var g=this;null===a&&((a=this.dO(null))?a={Ea:a,hJ:!0}:(a={Ea:g.Ow,
hJ:!1},g.GV(null,this.Ow)));a&&g.yQ(a,function(a){c.success&&c.success(g.ER(a,e,d,b))},c.error)};a.Ka.prototype.ER=function(f,d,b,c){return new a.Vd(d,f,this,b,c)};a.Ka.prototype.Vca=function(a,d){var b=this;return new Promise(function(c){function e(a,d,f){a<d.length?d.at(a,{deferred:!0}).then(function(l){if(l){var m=b.Bs(l);if(f===m.key){c(l);return}}a++;e(a,d,f)}):c(null)}e(0,a,d)})};a.Ka.prototype.RF=function(a,d,b){var c=this;return new Promise(function(e){c.Vca(a,d).then(function(g){function h(c,
g){if(c<k){var n=g.Yw(a.at(c));n.Ea?g.yQ(n,function(a){g.RF(a,d,b+1).then(function(a){a?e(a):(c++,h(c,g))})},null):(c++,h(c,g))}else e(null)}if(g)e({sn:g,depth:b});else{var k=a.length;h(0,c)}})})};a.Ka.prototype.yQ=function(a,d,b){a.hJ?d(a.Ea):(this.Gp&&"none"!==this.Gp&&(a.Ea.pJ=this.Gp,a.Ea.$K=this.Gs),0<a.Ea.length||!a.Ea.z0()?d(a.Ea):a.Ea.fetch({success:function(a){d(a)},error:b}))};a.Ka.prototype.ll=function(a,d){var b=this;null===a?this.Ls(null,0,-1,{success:function(a){a.AL({success:function(){d.success&&
d.success(a)}})}},null):this.RF(this.Ow,a,0).then(function(c){c&&(c=b.Yw(c.sn),b.Ls(c,0,-1,{success:function(a){a.AL({success:function(){d.success&&d.success(a)}})}},a))})};a.b.i("CollectionTreeDataSource.prototype.fetchDescendants",{ll:a.Ka.prototype.ll});a.Ka.prototype.sort=function(a,d){var b=a.key,c=a.direction,e=!1;b!==this.Gp&&(this.Gp=b,e=!0);c!==this.Gs&&(this.Gs=c,e=!0);if(e){"none"===this.Gs&&(this.Cd={});for(var g in this.Cd)this.Cd.hasOwnProperty(g)&&this.tO(this.Cd[g])}d&&d.success&&
d.success()};a.b.i("CollectionTreeDataSource.prototype.sort",{sort:a.Ka.prototype.sort});a.Ka.prototype.tO=function(a){a.comparator=this.Gp;a.sortDirection="ascending"===this.Gs?1:-1;a.sort()};a.Ka.prototype.lw=function(){return{key:this.Gp,direction:this.Gs}};a.b.i("CollectionTreeDataSource.prototype.getSortCriteria",{lw:a.Ka.prototype.lw});a.Ka.prototype.move=function(){a.j.Xa()};a.b.i("CollectionTreeDataSource.prototype.move",{move:a.Ka.prototype.move});a.Ka.prototype.Zi=function(){return"invalid"};
a.b.i("CollectionTreeDataSource.prototype.moveOK",{Zi:a.Ka.prototype.Zi});a.Ka.prototype.getCapability=function(a){return"sort"===a?"default":"move"===a?"none":"batchFetch"===a||"fetchDescendants"===a?"disable":null};a.b.i("CollectionTreeDataSource.prototype.getCapability",{getCapability:a.Ka.prototype.getCapability});a.Vd=function(a,d,b,c,e){this.MB=a;this.Ea=d;this.kJ=[];this.Vw=b;this.start=c<d.length?c:d.length-1;this.count=-1===e?d.length:Math.min(d.length,e)};o_("CollectionNodeSet",a.Vd,a);
a.Vd.prototype.AL=function(a){this.BQ(this).then(function(){a.success&&a.success()})};a.Vd.prototype.BQ=function(a){return new Promise(function(d){function b(e){e<c?a.p0(e,{success:function(c){null!==c?a.BQ(c).then(function(){b(e+1)}):b(e+1)}}):d(void 0)}var c=a.Q();b(0)})};a.Vd.prototype.p0=function(a,d){var b=this.Ea.at(a);if(this.Vw.Bs(b).leaf)this.kJ[a]=null,d.success(null);else{var c=this.Vw.Yw(b),b=this.Vw.Bs(b).key,e=this;this.Vw.Ls(c,0,-1,{success:function(b){e.kJ[a]=b;d.success(b)}},b)}};
a.Vd.prototype.getParent=function(){return this.MB};a.b.i("CollectionNodeSet.prototype.getParent",{getParent:a.Vd.prototype.getParent});a.Vd.prototype.ua=function(){return this.start};a.b.i("CollectionNodeSet.prototype.getStart",{ua:a.Vd.prototype.ua});a.Vd.prototype.Q=function(){return this.count};a.b.i("CollectionNodeSet.prototype.getCount",{Q:a.Vd.prototype.Q});a.Vd.prototype.getData=function(a){this.tE(a);return this.Ea.at(a).attributes};a.b.i("CollectionNodeSet.prototype.getData",{getData:a.Vd.prototype.getData});
a.Vd.prototype.tE=function(a){if(a<this.start||a>this.start+this.count)throw"Out of range";};a.Vd.prototype.getMetadata=function(a){this.tE(a);var d={};a=this.Ea.at(a);a=this.Vw.Bs(a);d.key=a.key;d.leaf=a.leaf;d.depth=a.depth;return d};a.b.i("CollectionNodeSet.prototype.getMetadata",{getMetadata:a.Vd.prototype.getMetadata});a.Vd.prototype.pf=function(a){this.tE(a);return this.kJ[a]};a.b.i("CollectionNodeSet.prototype.getChildNodeSet",{pf:a.Vd.prototype.pf})});